name: Eval Gate
on: [push, pull_request]

jobs:
  evals:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Build index
        run: python app/rag/ingest.py
      - name: Run evals (print metrics)
        run: python -m evals.run
      - name: Enforce pass-rate threshold
        run: |
          OUT=$(python -m evals.run | tail -n 2 | head -n 1)
          echo "$OUT"
          RATE=$(echo "$OUT" | sed -n 's/.*Pass-rate: \([0-9.]*\)%.*/\1/p')
          echo "Detected pass-rate: $RATE"
          THRESH=100.0     # change to 95.0 if you want a lower gate
          awk -v r="$RATE" -v t="$THRESH" 'BEGIN{ if (r+0 < t+0) { exit 1 } }'
